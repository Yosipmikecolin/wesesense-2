import { RequesterPost } from "@/db/requester";
import { getDate } from "@/functions";
import {
  FormDataCarrier,
  FormDataWearer,
  Step1Data,
  Step2Data,
  Step3Data,
  Step4Data,
  Step5Data,
  Step6Data,
} from "@/views/view-create-carrier/interfaces";
import { RequestTable } from "@/views/view-create-request/interfaces";
import {
  Document,
  Packer,
  Paragraph,
  TextRun,
  Table,
  TableRow,
  TableCell,
  AlignmentType,
  WidthType,
} from "docx";
import { saveAs } from "file-saver";
import { request } from "http";
import jsPDF from "jspdf";
import * as XLSX from "xlsx";

function getHour(): string {
  const ahora = new Date();
  const horas = ahora.getHours().toString().padStart(2, "0");
  const minutos = ahora.getMinutes().toString().padStart(2, "0");
  const segundos = ahora.getSeconds().toString().padStart(2, "0");

  return `${horas}:${minutos}:${segundos}`;
}

const getValue = (key: string, selectedCarrier: Step1Data | any) => {
  switch (key) {
    case "date":
      return getDate() + " - " + getHour();

    case "test":
      return "Abogado";

    case "nameComplete":
      return (
        selectedCarrier.fullName +
        " " +
        selectedCarrier.paternalSurname +
        " " +
        selectedCarrier.motherSurname
      );

    case "response":
      return returnStatus(selectedCarrier.answer);

    default:
      return selectedCarrier[key] ?? "N/A";
  }
};

const returnStatus = (answer: string) => {
  switch (answer) {
    case "positive":
      return "Positivo";

    case "negative":
      return "Negativo";

    case "not-recommended":
      return "No recomendable";

    default:
      return undefined;
  }
};

export const generatePDF = (selectedCarrier: RequestTable) => {
  const doc = new jsPDF();

  // üé® Encabezado
  doc.setFillColor(34, 197, 94);
  doc.rect(0, 0, 210, 20, "F");
  doc.setFontSize(20);
  doc.setTextColor(255, 255, 255);
  doc.text("Informe de factibilidad t√©cnica", 105, 12, {
    align: "center",
  });

  // üóÇÔ∏è Definici√≥n de secciones y sus campos
  const sections: {
    title: string;
    data:
      | RequestTable
      | Step1Data
      | Step2Data
      | Step3Data
      | Step4Data
      | Step5Data
      | Step6Data
      | RequesterPost;
    fields: { key: string; label: string }[];
  }[] = [
    {
      title: "---------",
      data: selectedCarrier,
      fields: [
        /*  { key: "crime", label: "Delito" }, */
        { key: "date", label: "Fecha y Hora" },
        { key: "law", label: "Tipo de ley" },
        { key: "folio", label: "Folio" },
        { key: "response", label: "Respuesta de la empresa" },
      ],
    },

    {
      title: "Informaci√≥n de la causa",
      data: selectedCarrier.carrier.cause,
      fields: [
        /*  { key: "crime", label: "Delito" }, */
        { key: "test", label: "Tipo de solicitante" },
        { key: "courtRegion", label: "Regi√≥n" },
        { key: "court", label: "Tribunal/Juzgado" },
        /* { key: "rol", label: "ROL" }, */
        { key: "penatype", label: "Tipo de Pena Sustantiva" },
        { key: "rit", label: "RIT" },
        { key: "ruc", label: "RUC" },
      ],
    },
    {
      title: "Datos del solicitante",
      data: selectedCarrier.requester,
      fields: [
        { key: "test", label: "Tipo de requirente" },
        { key: "institution", label: "Nombre del tribunal" },
        { key: "email", label: "Correo electronico" },
        { key: "phone", label: "Tel√©fono del Tribunal" },
      ],
    },

    {
      title: "Datos de la persona sujeta control / Condenado",
      data: selectedCarrier.carrier.personalData,
      fields: [
        { key: "nameComplete", label: "Nombre Completo" },
        /*   { key: "socialName", label: "Nombre Social" },
        { key: "paternalSurname", label: "Apellido Paterno" },
        { key: "motherSurname", label: "Apellido Materno" },
        { key: "type_current", label: "Tipo Actual" },
        { key: "gender", label: "G√©nero" }, */
        { key: "dateBirth", label: "Fecha de Nacimiento" },
        { key: "run", label: "RUT" },
        /*      { key: "maritalStatus", label: "Estado Civil" },
        { key: "nationality", label: "Nacionalidad" },
        { key: "run", label: "RUN" },
        { key: "phone", label: "Tel√©fono" },
        { key: "foreigner", label: "Extranjero" }, */
      ],
    },
    /*     {
      title: "Monitoreo",
      data: selectedCarrier.monitoring,
      fields: [
        { key: "crs", label: "CRS" },
        { key: "areas", label: "√Åreas" },
        { key: "durationMeasurement", label: "Medida de Duraci√≥n" },
        { key: "controlSchedule", label: "Horario de Control" },
        { key: "effectivePeriod", label: "Per√≠odo Efectivo" },
        { key: "requestsFeasibility", label: "Solicitudes de Viabilidad" },
        { key: "judgment", label: "Juicio" },
        {
          key: "programmingInstallation",
          label: "Programaci√≥n de Instalaci√≥n",
        },
        { key: "installationsDone", label: "Instalaciones Realizadas" },
        { key: "modificationResolution", label: "Resoluci√≥n de Modificaci√≥n" },
        { key: "technicalSupports", label: "Soportes T√©cnicos" },
        { key: "nonReports", label: "Reportes No Realizados" },
        { key: "daysControl", label: "D√≠as de Control" },
        { key: "uninstallations", label: "Desinstalaciones" },
      ],
    }, */
    {
      title: "√Årea de inclusi√≥n",
      data: selectedCarrier.carrier.inclusionArea,
      fields: [
        { key: "street", label: "Calle" },
        { key: "number", label: "N√∫mero" },
        { key: "additionalInformation", label: "Informaci√≥n Adicional" },
        { key: "commune", label: "Comuna" },
        { key: "region", label: "Regi√≥n" },
        { key: "road", label: "Camino" },
        { key: "population", label: "Poblaci√≥n" },
        { key: "zipCode", label: "C√≥digo Postal" },
        { key: "geographicCoordinates", label: "Coordenadas Geogr√°ficas" },
        { key: "radio", label: "Radio" },
        { key: "complianceSchedule", label: "Horario de Cumplimiento" },
        { key: "characteristics", label: "Caracter√≠sticas" },
      ],
    },
    {
      title: "√Årea de exclusi√≥n",
      data: selectedCarrier.carrier.exclusionArea,
      fields: [
        { key: "street", label: "Calle" },
        { key: "number", label: "N√∫mero" },
        { key: "additionalInformation", label: "Informaci√≥n Adicional" },
        { key: "commune", label: "Comuna" },
        { key: "region", label: "Regi√≥n" },
        { key: "road", label: "Camino" },
        { key: "population", label: "Poblaci√≥n" },
        { key: "zipCode", label: "C√≥digo Postal" },
        { key: "geographicCoordinates", label: "Coordenadas Geogr√°ficas" },
        { key: "radio", label: "Radio" },
        { key: "characteristics", label: "Caracter√≠sticas" },
        { key: "paternalSurname", label: "Apellido Paterno" },
        { key: "motherSurname", label: "Apellido Materno" },
        { key: "names", label: "Nombres" },
        { key: "rut", label: "RUT" },
        { key: "victimEmail", label: "Correo de la V√≠ctima" },
        { key: "homeTelephone", label: "Tel√©fono Domicilio" },
        { key: "workplaceTelephone", label: "Tel√©fono Trabajo" },
      ],
    },

    {
      title: "Informaci√≥n de V√≠ctima ",
      data: selectedCarrier.carrier.exclusionArea,
      fields: [
        { key: "paternalSurname", label: "Apellido Paterno" },
        { key: "motherSurname", label: "Apellido Materno" },
        { key: "names", label: "Nombres" },
        { key: "rut", label: "RUT" },
        { key: "victimEmail", label: "Correo de la V√≠ctima" },
        { key: "homeTelephone", label: "Tel√©fono Domicilio" },
        { key: "workplaceTelephone", label: "Tel√©fono Trabajo" },
      ],
    },
  ];

  // üóÇÔ∏è Generaci√≥n de secciones
  let y = 30;

  sections.forEach(({ title, data, fields }, sectionIndex) => {
    // T√≠tulo de la secci√≥n
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(34, 197, 94);
    doc.text(title, 15, y);
    y += 8;

    fields.forEach(({ key, label }, index) => {
      // Salto de p√°gina si es necesario
      if (y > 260) {
        doc.addPage();
        y = 20;
      }

      const value =
        (data as unknown as Record<string, unknown>)?.[key] ??
        getValue(key, data as Step1Data);

      // Fondo alternado
      if (index % 2 === 0) {
        doc.setFillColor(240, 253, 244);
        doc.rect(10, y - 6, 190, 8, "F");
      }

      // Etiqueta
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.setTextColor(51, 51, 51);
      doc.text(`${label}:`, 15, y);

      // Valor
      doc.setFont("helvetica", "normal");
      doc.text(value.toString(), 80, y);

      y += 10;
    });

    // Espacio entre secciones
    y += 10;

    // Salto de p√°gina si es necesario despu√©s de la secci√≥n
    if (y > 260 && sectionIndex < sections.length - 1) {
      doc.addPage();
      y = 20;
    }
  });

  // üé® Footer
  doc.setFillColor(34, 197, 94);
  doc.rect(0, 280, 210, 20, "F");
  doc.setFontSize(10);
  doc.setTextColor(255, 255, 255);
  doc.text("Generado con SGAMGC", 105, 289, { align: "center" });

  // Guardar el archivo
  const nameFile = selectedCarrier.carrier.personalData.fullName
    .split(" ")
    .join("_")
    .toLowerCase();
  doc.save(`Informe_${nameFile}.pdf`);
};

interface Field {
  key: keyof FormDataCarrier; // Uni√≥n de todas las claves: "fullName" | "socialName" | "nationality" | etc.
  label: string;
}

interface Section {
  title: string;
  fields: Field[];
}

export const generateWord = (selectedCarrier: FormDataWearer) => {
  // üóÇÔ∏è Definici√≥n de secciones y sus campos
  const sections = [
    {
      title: "Informaci√≥n Personal",
      data: selectedCarrier.wearer,
      fields: [
        { key: "first_name", label: "Nombres" },
        { key: "surname", label: "Apellidos" },
        { key: "email", label: "Email" },
      ],
    },
    // {
    //   title: "Informaci√≥n Personal",
    //   data: selectedCarrier.personalData,
    //   fields: [
    //     { key: "fullname", label: "Nombre Completo" },
    //     { key: "socialName", label: "Nombre Social" },
    //     { key: "paternalSurname", label: "Apellido Paterno" },
    //     { key: "motherSurname", label: "Apellido Materno" },
    //     { key: "type_current", label: "Tipo Actual" },
    //     { key: "gender", label: "G√©nero" },
    //     { key: "dateBirth", label: "Fecha de Nacimiento" },
    //     { key: "maritalStatus", label: "Estado Civil" },
    //     { key: "nationality", label: "Nacionalidad" },
    //     { key: "run", label: "RUN" },
    //     { key: "phone", label: "Tel√©fono" },
    //     { key: "foreigner", label: "Extranjero" },
    //   ],
    // },
    // {
    //   title: "Causa",
    //   data: selectedCarrier.cause,
    //   fields: [
    //     { key: "penatype", label: "Tipo de Pena" },
    //     { key: "crime", label: "Delito" },
    //     { key: "courtAppeals", label: "Corte de Apelaciones" },
    //     { key: "courtRegion", label: "Regi√≥n del Tribunal" },
    //     { key: "court", label: "Tribunal" },
    //     { key: "ruc", label: "RUC" },
    //     { key: "rit", label: "RIT" },
    //     { key: "rol", label: "ROL" },
    //   ],
    // },
    // {
    //   title: "Monitoreo",
    //   data: selectedCarrier.monitoring,
    //   fields: [
    //     { key: "crs", label: "CRS" },
    //     { key: "areas", label: "√Åreas" },
    //     { key: "durationMeasurement", label: "Medida de Duraci√≥n" },
    //     { key: "controlSchedule", label: "Horario de Control" },
    //     { key: "effectivePeriod", label: "Per√≠odo Efectivo" },
    //     { key: "requestsFeasibility", label: "Solicitudes de Viabilidad" },
    //     { key: "judgment", label: "Juicio" },
    //     {
    //       key: "programmingInstallation",
    //       label: "Programaci√≥n de Instalaci√≥n",
    //     },
    //     { key: "installationsDone", label: "Instalaciones Realizadas" },
    //     { key: "modificationResolution", label: "Resoluci√≥n de Modificaci√≥n" },
    //     { key: "technicalSupports", label: "Soportes T√©cnicos" },
    //     { key: "nonReports", label: "Reportes No Realizados" },
    //     { key: "daysControl", label: "D√≠as de Control" },
    //     { key: "uninstallations", label: "Desinstalaciones" },
    //   ],
    // },
    // {
    //   title: "√Årea de inclusi√≥n",
    //   data: selectedCarrier.inclusionArea,
    //   fields: [
    //     { key: "street", label: "Calle" },
    //     { key: "number", label: "N√∫mero" },
    //     { key: "additionalInformation", label: "Informaci√≥n Adicional" },
    //     { key: "commune", label: "Comuna" },
    //     { key: "region", label: "Regi√≥n" },
    //     { key: "road", label: "Camino" },
    //     { key: "population", label: "Poblaci√≥n" },
    //     { key: "zipCode", label: "C√≥digo Postal" },
    //     { key: "geographicCoordinates", label: "Coordenadas Geogr√°ficas" },
    //     { key: "radio", label: "Radio" },
    //     { key: "complianceSchedule", label: "Horario de Cumplimiento" },
    //     { key: "characteristics", label: "Caracter√≠sticas" },
    //   ],
    // },
    // {
    //   title: "√Årea de exclusi√≥n y Informaci√≥n de V√≠ctima ",
    //   data: selectedCarrier.exclusionArea,
    //   fields: [
    //     { key: "street", label: "Calle" },
    //     { key: "number", label: "N√∫mero" },
    //     { key: "additionalInformation", label: "Informaci√≥n Adicional" },
    //     { key: "commune", label: "Comuna" },
    //     { key: "region", label: "Regi√≥n" },
    //     { key: "road", label: "Camino" },
    //     { key: "population", label: "Poblaci√≥n" },
    //     { key: "zipCode", label: "C√≥digo Postal" },
    //     { key: "geographicCoordinates", label: "Coordenadas Geogr√°ficas" },
    //     { key: "radio", label: "Radio" },
    //     { key: "characteristics", label: "Caracter√≠sticas" },
    //     { key: "paternalSurname", label: "Apellido Paterno" },
    //     { key: "motherSurname", label: "Apellido Materno" },
    //     { key: "names", label: "Nombres" },
    //     { key: "rut", label: "RUT" },
    //     { key: "victimEmail", label: "Correo de la V√≠ctima" },
    //     { key: "homeTelephone", label: "Tel√©fono Domicilio" },
    //     { key: "workplaceTelephone", label: "Tel√©fono Trabajo" },
    //   ],
    // },
  ];

  // üóÇÔ∏è Generaci√≥n de secciones
  const sectionElements = sections.map((section) => {
    // Crear filas de la tabla para los campos
    const tableRows = section.fields.map((field, index) => {
      return new TableRow({
        children: [
          new TableCell({
            children: [
              new Paragraph({
                children: [
                  new TextRun({
                    text: field.label,
                    bold: true,
                    font: "Arial",
                    size: 24,
                  }),
                ],
              }),
            ],
            shading: { fill: index % 2 === 0 ? "F0FDF4" : "FFFFFF" }, // Fondo alternado
          }),
          new TableCell({
            children: [
              new Paragraph({
                children: [
                  new TextRun({
                    text:
                      section.data[field.key as keyof typeof section.data] ??
                      "-",
                    font: "Arial",
                    size: 24,
                  }),
                ],
              }),
            ],
          }),
        ],
      });
    });

    // Espaciado adicional antes de ciertas secciones
    const isMajorSection = [
      "Informaci√≥n Personal (Paso 1)",
      "Informaci√≥n Legal (Paso 2)",
      "Control y Seguimiento (Paso 3)",
    ].includes(section.title);
    const spacingBefore = isMajorSection ? { before: 600 } : { before: 200 };

    return [
      new Paragraph({
        children: [],
        spacing: spacingBefore,
      }),
      new Paragraph({
        children: [
          new TextRun({
            text: section.title,
            bold: true,
            font: "Arial",
            size: 28,
            color: "FFFFFF",
          }),
        ],
        shading: { fill: "22C55E" },
        alignment: AlignmentType.CENTER,
        spacing: { after: 200 },
      }),
      new Table({
        rows: [
          new TableRow({
            children: [
              new TableCell({
                children: [
                  new Paragraph({
                    children: [
                      new TextRun({
                        text: "Campo",
                        bold: true,
                        font: "Arial",
                        size: 26,
                        color: "FFFFFF",
                      }),
                    ],
                  }),
                ],
                shading: { fill: "22C55E" },
              }),
              new TableCell({
                children: [
                  new Paragraph({
                    children: [
                      new TextRun({
                        text: "Valor",
                        bold: true,
                        font: "Arial",
                        size: 26,
                        color: "FFFFFF",
                      }),
                    ],
                  }),
                ],
                shading: { fill: "22C55E" },
              }),
            ],
          }),
          ...tableRows,
        ],
        width: { size: 100, type: WidthType.PERCENTAGE },
      }),
    ];
  });

  // üìÑ Crear el documento
  const doc = new Document({
    sections: [
      {
        properties: {},
        children: [
          new Paragraph({
            children: [
              new TextRun({
                text: "Informe de factibilidad t√©cnica",
                bold: true,
                font: "Arial",
                size: 36,
                color: "FFFFFF",
              }),
            ],
            alignment: AlignmentType.CENTER,
            shading: { fill: "22C55E" },
            spacing: { after: 300 },
          }),
          ...sectionElements.flat(),
          new Paragraph({
            children: [
              new TextRun({
                text: "Generado con SGAMGC",
                italics: true,
                font: "Arial",
                size: 20,
                color: "AAAAAA",
              }),
            ],
            alignment: AlignmentType.CENTER,
            spacing: { before: 300 },
          }),
        ],
      },
    ],
  });

  // üíæ Guardar el archivo
  Packer.toBlob(doc).then((blob) => {
    const nameFile = selectedCarrier.wearer.first_name
      .split(" ")
      .join("_")
      .toLowerCase();
    saveAs(blob, `detalles_${nameFile}.docx`);
  });
};

export const exportToExcel = (requests: RequestTable[]) => {
  // Define el tipo del objeto aplanado
  interface FlattenedData {
    [key: string]: string | number | boolean | undefined;
  }

  // Flatten the nested data for Excel with Spanish column names
  const flattenedDataArray: FlattenedData[] = requests.map((request) => ({
    Respuesta: request.answer,
    Fecha_Emisi√≥n: request.issue_date,
    Estado: request.status,

    // Datos del Solicitante
    Solicitante_Nombre_Completo: request.requester.fullName,
    Solicitante_Apellido: request.requester.lastName,
    Solicitante_Segundo_Nombre: request.requester.middleName,
    Solicitante_Correo: request.requester.email,
    Solicitante_RUN: request.requester.run,
    Solicitante_Tel√©fono: request.requester.phone,
    Solicitante_Tipo_Usuario: request.requester.userType,
    Solicitante_Instituci√≥n: request.requester.institution,
    Solicitante_N√∫mero_Identificaci√≥n: request.requester.identificationNumber,
    Solicitante_Regi√≥n: request.requester.region,
    Solicitante_Direcci√≥n: request.requester.address,
    Solicitante_√Åreas_Acceso: request.requester.accessAreas,
    Solicitante_Verificaci√≥n_Identidad: request.requester.identityVerification,
    Solicitante_Pregunta_Seguridad: request.requester.securityQuestion,
    Solicitante_Fecha_Registro: request.requester.registrationDate,
    Solicitante_Observaciones: request.requester.observations,

    // Portador: Datos Personales
    Portador_DatosPersonales_Nombre_Completo:
      request.carrier.personalData.fullName,
    Portador_DatosPersonales_Nombre_Social:
      request.carrier.personalData.socialName,
    Portador_DatosPersonales_Apellido_Paterno:
      request.carrier.personalData.paternalSurname,
    Portador_DatosPersonales_Apellido_Materno:
      request.carrier.personalData.motherSurname,
    Portador_DatosPersonales_Sexo: request.carrier.personalData.sex,
    Portador_DatosPersonales_Tipo_Actual:
      request.carrier.personalData.type_current,
    Portador_DatosPersonales_G√©nero: request.carrier.personalData.gender,
    Portador_DatosPersonales_Fecha_Nacimiento:
      request.carrier.personalData.dateBirth,
    Portador_DatosPersonales_Estado_Civil:
      request.carrier.personalData.maritalStatus,
    Portador_DatosPersonales_Nacionalidad:
      request.carrier.personalData.nationality,
    Portador_DatosPersonales_RUN: request.carrier.personalData.run,
    Portador_DatosPersonales_Tel√©fono: request.carrier.personalData.phone,
    Portador_DatosPersonales_Extranjero: request.carrier.personalData.foreigner
      ? "S√≠"
      : "No",

    // Portador: Causa
    Portador_Causa_Tipo_Pena: request.carrier.cause.penatype,
    Portador_Causa_Delito: request.carrier.cause.crime,
    Portador_Causa_Corte_Apelaciones: request.carrier.cause.courtAppeals,
    Portador_Causa_Regi√≥n_Corte: request.carrier.cause.courtRegion,
    Portador_Causa_Corte: request.carrier.cause.court,
    Portador_Causa_RUC: request.carrier.cause.ruc,
    Portador_Causa_RIT: request.carrier.cause.rit,
    Portador_Causa_ROL: request.carrier.cause.rol,

    // Portador: Monitoreo
    Portador_Monitoreo_√Åreas: request.carrier.monitoring.areas,
    Portador_Monitoreo_Duraci√≥n_Medida:
      request.carrier.monitoring.durationMeasurement,
    Portador_Monitoreo_Horario_Control:
      request.carrier.monitoring.controlSchedule,
    Portador_Monitoreo_Periodo_Efectivo:
      request.carrier.monitoring.effectivePeriod,
    Portador_Monitoreo_Solicitudes_Viabilidad:
      request.carrier.monitoring.requestsFeasibility,
    Portador_Monitoreo_Sentencia: request.carrier.monitoring.judgment,
    Portador_Monitoreo_Programaci√≥n_Instalaci√≥n:
      request.carrier.monitoring.programmingInstallation,
    Portador_Monitoreo_Instalaciones_Realizadas:
      request.carrier.monitoring.installationsDone,
    Portador_Monitoreo_Resoluci√≥n_Modificaci√≥n:
      request.carrier.monitoring.modificationResolution,
    Portador_Monitoreo_Soportes_T√©cnicos:
      request.carrier.monitoring.technicalSupports,
    Portador_Monitoreo_No_Informes: request.carrier.monitoring.nonReports,
    Portador_Monitoreo_D√≠as_Control: request.carrier.monitoring.daysControl,
    Portador_Monitoreo_Desinstalaciones:
      request.carrier.monitoring.uninstallations,

    // Portador: √Årea de Inclusi√≥n
    Portador_√ÅreaInclusi√≥n_Calle: request.carrier.inclusionArea.street,
    Portador_√ÅreaInclusi√≥n_N√∫mero: request.carrier.inclusionArea.number,
    Portador_√ÅreaInclusi√≥n_Informaci√≥n_Adicional:
      request.carrier.inclusionArea.additionalInformation,
    Portador_√ÅreaInclusi√≥n_Comuna: request.carrier.inclusionArea.commune,
    Portador_√ÅreaInclusi√≥n_Regi√≥n: request.carrier.inclusionArea.region,
    Portador_√ÅreaInclusi√≥n_Camino: request.carrier.inclusionArea.road,
    Portador_√ÅreaInclusi√≥n_Poblaci√≥n: request.carrier.inclusionArea.population,
    Portador_√ÅreaInclusi√≥n_C√≥digo_Postal: request.carrier.inclusionArea.zipCode,
    Portador_√ÅreaInclusi√≥n_Coordenadas_Geogr√°ficas:
      request.carrier.inclusionArea.geographicCoordinates,
    Portador_√ÅreaInclusi√≥n_Radio: request.carrier.inclusionArea.radio,
    Portador_√ÅreaInclusi√≥n_Horario_Cumplimiento:
      request.carrier.inclusionArea.complianceSchedule,
    Portador_√ÅreaInclusi√≥n_Caracter√≠sticas:
      request.carrier.inclusionArea.characteristics,

    // Portador: √Årea de Exclusi√≥n
    Portador_√ÅreaExclusi√≥n_Calle: request.carrier.exclusionArea.street,
    Portador_√ÅreaExclusi√≥n_N√∫mero: request.carrier.exclusionArea.number,
    Portador_√ÅreaExclusi√≥n_Informaci√≥n_Adicional:
      request.carrier.exclusionArea.additionalInformation,
    Portador_√ÅreaExclusi√≥n_Comuna: request.carrier.exclusionArea.commune,
    Portador_√ÅreaExclusi√≥n_Regi√≥n: request.carrier.exclusionArea.region,
    Portador_√ÅreaExclusi√≥n_Camino: request.carrier.exclusionArea.road,
    Portador_√ÅreaExclusi√≥n_Poblaci√≥n: request.carrier.exclusionArea.population,
    Portador_√ÅreaExclusi√≥n_C√≥digo_Postal: request.carrier.exclusionArea.zipCode,
    Portador_√ÅreaExclusi√≥n_Coordenadas_Geogr√°ficas:
      request.carrier.exclusionArea.geographicCoordinates,
    Portador_√ÅreaExclusi√≥n_Radio: request.carrier.exclusionArea.radio,
    Portador_√ÅreaExclusi√≥n_Caracter√≠sticas:
      request.carrier.exclusionArea.characteristics,
    Portador_√ÅreaExclusi√≥n_Apellido_Paterno:
      request.carrier.exclusionArea.paternalSurname,
    Portador_√ÅreaExclusi√≥n_Apellido_Materno:
      request.carrier.exclusionArea.motherSurname,
    Portador_√ÅreaExclusi√≥n_Nombres: request.carrier.exclusionArea.names,
    Portador_√ÅreaExclusi√≥n_RUT: request.carrier.exclusionArea.rut,
    Portador_√ÅreaExclusi√≥n_Correo_V√≠ctima:
      request.carrier.exclusionArea.victimEmail,
    Portador_√ÅreaExclusi√≥n_Tel√©fono_Domicilio:
      request.carrier.exclusionArea.homeTelephone,
    Portador_√ÅreaExclusi√≥n_Tel√©fono_Trabajo:
      request.carrier.exclusionArea.workplaceTelephone,

    // Respuesta del Adjudicatario
    Adjudicatario_Cobertura_M√≠nima: request.awardee_response.minimum_coverage,
    Adjudicatario_Estado: request.awardee_response.status,
    Adjudicatario_Latitud: request.awardee_response.latitude,
    Adjudicatario_Longitud: request.awardee_response.length,
    Adjudicatario_Aspectos_Indicaci√≥n:
      request.awardee_response.indication_aspects,
    Adjudicatario_Valor: request.awardee_response.value,
    Adjudicatario_Evidencia_Fotogr√°fica:
      request.awardee_response.photographic_evidence.join(", "),

    // Motivos de Revoluci√≥n del Solicitante
    Motivos_Revoluci√≥n_Solicitante: request.reason_revolution_requester
      .map(
        (r, index) =>
          `Motivo ${index + 1}: ${r.reason_return}, Descripci√≥n: ${
            r.description_reason
          }`
      )
      .join("; "),

    // Motivos de Revoluci√≥n del Adjudicatario
    Motivos_Revoluci√≥n_Adjudicatario: request.reason_revolution_awardee
      .map(
        (r, index) =>
          `Motivo ${index + 1}: ${r.reason_return}, Descripci√≥n: ${
            r.description_reason
          }`
      )
      .join("; "),
  }));

  // Create worksheet from the array of flattened data
  const worksheet = XLSX.utils.json_to_sheet(flattenedDataArray);

  // Create workbook and add worksheet
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Datos Solicitudes");

  // Auto-size columns (approximate)
  const colWidths = Object.keys(flattenedDataArray[0] || {}).map((key) => {
    const maxLength = Math.max(
      key.length,
      ...flattenedDataArray.map((data) => String(data[key] || "").length)
    );
    return { wch: maxLength > 50 ? 50 : maxLength };
  });
  worksheet["!cols"] = colWidths;

  // Generate Excel file
  const fileName = `Solicitudes_${new Date().toISOString().slice(0, 10)}.xlsx`;
  XLSX.writeFile(workbook, fileName);
};
